{% extends "base.html" %}

{% block extrahead %}
  {{ super() }}

  {# Expose page + admin password via meta #}
  {% if page and page.meta and page.meta.password %}
    <meta name="page-password" content="{{ page.meta.password | e }}">
  {% endif %}
  {% if page and page.meta and page.meta.lock_prompt %}
    <meta name="page-prompt" content="{{ page.meta.lock_prompt | e }}">
  {% endif %}
  {% if config.extra and config.extra.admin_password %}
    <meta name="admin-password" content="{{ config.extra.admin_password | e }}">
  {% endif %}

  <style>
    html[data-locked="true"] body { visibility: hidden; }
  </style>

  <script>
    (function() {
      function getMeta(name) {
        var m = document.querySelector('meta[name="' + name + '"]');
        return m ? m.getAttribute('content') : null;
      }

      var pagePw   = getMeta('page-password');
      var adminPw  = getMeta('admin-password');
      var pageHint = getMeta('page-prompt'); // optional, from front matter

      // Mark locked early to prevent flicker
      if (pagePw) document.documentElement.setAttribute('data-locked', 'true');
      if (!pagePw) return;

      var pageKey = 'unlocked:' + location.pathname;

      // Already unlocked?
      if (sessionStorage.getItem(pageKey) === '1') {
        document.documentElement.removeAttribute('data-locked');
        return;
      }

      // Build prompt text
      var base = 'This page is locked.';
      var suffix = pageHint ? ' ' + pageHint : '';
      var promptText = base + suffix + '\nEnter password:';

      // Prompt up to 5 times
      var ok = false;
      for (var tries = 0; tries < 5; tries++) {
        var input = window.prompt(promptText);
        if (input === null) break;
        if ((adminPw && input === adminPw) || input === pagePw) { ok = true; break; }
        alert('Incorrect password. Try again.');
      }

      if (ok) {
        sessionStorage.setItem(pageKey, '1');
        document.documentElement.removeAttribute('data-locked');
      } else {
        document.body.innerHTML = '<div style="padding:2rem;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial">Access denied.</div>';
        document.documentElement.removeAttribute('data-locked');
      }
    })();
  </script>
{% endblock %}

